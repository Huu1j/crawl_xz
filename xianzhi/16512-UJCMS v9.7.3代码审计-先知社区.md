# UJCMS v9.7.3代码审计-先知社区

> **来源**: https://xz.aliyun.com/news/16512  
> **文章ID**: 16512

---

# 前言

网上开源CMS基本上出来一个星期左右就没戏了，但是还是想试一试，随便找一套源代码，简单审计一下，看看有无收获

# 审计

登录网站，文件处可进行文件上传

![](images/20250104223516-1db8318e-caa9-1.png)  
上传文件发现jsp和jspx都不行，这里一般就是做了过滤，但是我们可以通过代码审计来分析一下

![](images/20250104223531-26bcbcbe-caa9-1.png)

![](images/20250104223539-2b342016-caa9-1.png)  
通过上述我们可以知道文件上传处理接口为/api/backend/core/web-file-upload/upload，我们可以直接搜索关键词来定位关键代码

![](images/20250104223551-32a564fe-caa9-1.png)  
发现文件处理代码

![](images/20250104223601-3889e48a-caa9-1.png)  
我们通过上述代码可知主要由100行的upload进行处理，跟进upload函数跳转至如下图121进行处理

![](images/20250104223619-4346ea3a-caa9-1.png)  
通过上图发现在125行存在checkName函数，跟进函数，发现此处正是抓包上传脚本文件回显异常处理的代码，并且在227行先对扩展名进行统一转换为大小写然后进行判断

![](images/20250104223634-4bc70f14-caa9-1.png)  
通过上图我们可以知道由getFilesExtensionExcludes函数对我们的文件后缀进行检测，我们跟进该函数发现跳转至如下图，定义了一个filesExtensionBlacklist变量

![](images/20250104223646-534dfc52-caa9-1.png)  
发现该变量主要是对脚本文件后缀进行处理但是，并没有对html后缀进行处理，并且使用的黑名单过滤，明显还存在jspa这种后缀可以进行上传

![](images/20250104223657-599c5b44-caa9-1.png)  
我们通过测试，发现jspa文件上传成功，但是访问文件时进行了下载，猜测是spring框架的问题  
这里说一下，互联网上有大佬可以进行上传web.xml覆盖tomcat文件进行getshell，有兴趣的师傅可以试一下

![](images/20250104223711-62541f92-caa9-1.png)

![](images/20250104223717-656855cc-caa9-1.png)

![](images/20250104223721-6814fa82-caa9-1.png)  
但是可以上传html文件造成存储型XSS

![](images/20250104223734-6fdd14ca-caa9-1.png)

![](images/20250104223741-73aa680a-caa9-1.png)  
通过上述我们发现其实黑名单进行文件后缀过滤是非常不安全得，并且该CMS我感觉在黑名单变量处理处存在缺陷，如下图所示，我们发现存在两个文件上传的变量，但是对于后缀的过滤确实不同的，明显filesExtensionBlacklist变量过滤的更少，且相较于uploadExtensionBlacklist变量而言没有过滤html相关的前端文件后缀，因此造成XSS产生

![](images/20250104223753-7b242260-caa9-1.png)  
这里模板文件模块处存在模板编辑功能，也可进行存储型XSS

![](images/20250104223804-819fdc42-caa9-1.png)
