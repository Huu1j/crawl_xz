# 初识ADS-先知社区

> **来源**: https://xz.aliyun.com/news/16881  
> **文章ID**: 16881

---

# 初识ADS

ADS (Alternate Data Streams) 是NTFS磁盘格式的一个特性

在NTFS文件系统下，所有文件都是一个数据流 默认都是未命名的流 但是NTFS也允许我们创建额外的数据流(命名的)

那么如何使用这个命名的数据流呢?

首先我们先来了解一下文件的完整名称

![](images/20250220105006-64423b08-ef35-1.png)

<filename>:<stream name>:<stream type>

文件名 流名称 类型

所以test.txt实际上是test.txt::#DATA

![](images/20250220105007-651330c8-ef35-1.png)

可以通过重定向的方式 直接写到命名的流中

![](images/20250220105008-659d10ce-ef35-1.png)

通过DIR /R 可以查看ADS

![](images/20250220105009-660ff016-ef35-1.png)

可以通过powershell的Remove-Item 删除指定流

powershell -Command "Remove-Item -Path test.txt -Stream test"

该特性适用于文件夹

![](images/20250220105010-669929b6-ef35-1.png)

# windows API操作ADS

```
#include <iostream>
 #include <Windows.h>
 
 int main(){
     
     HANDLE hFile = NULL;
     DWORD dwBytesWritten = NULL;
     char buf[] = "114514";
     hFile = CreateFileW(L"D:\Desktop\ADS\test\test.txt:test:$DATA", GENERIC_READ | GENERIC_WRITE, FILE_SHARE_READ, NULL, OPEN_ALWAYS, FILE_ATTRIBUTE_NORMAL, NULL);
     if (hFile != INVALID_HANDLE_VALUE) {
         WriteFile(hFile,buf,sizeof(buf),&dwBytesWritten,NULL);
     }
 }
```

CreateFile 支持ADS 所以直接操作就行

![](images/20250220105011-67286aa5-ef35-1.png)

可以通过重定向来查看其内容 more < xxxxxx

![](images/20250220105012-6781e2ad-ef35-1.png)

读也是一样

![](images/20250220105013-681a51e2-ef35-1.png)

![](images/20250220105013-688d9e79-ef35-1.png)

可以通过findFirstStreamWFindNextStreamW 来枚举$DATA类型的流

![](images/20250220105014-6929bec1-ef35-1.png)

# 执行PE程序

## wmic

可以通过wmic 来执行ADS中的PE程序

wmic process call create D:\Desktop\ADS est\calc.exe:test

值得注意的是 这里必须是绝对路径

![](images/20250220105016-69f4a849-ef35-1.png)

## Control

可以利用control来执行dll 不需要绝对路径

![](images/20250220105017-6a8fc3a4-ef35-1.png)

## rundll32

rundll32也支持ADS 不需要绝对路径

![](images/20250220105018-6b58c8e0-ef35-1.png)

![](images/20250220105020-6c518f30-ef35-1.png)

## Forfiles

可以通过Forfiles命令的/C参数对所有遍历到的文件运行指定的命令 比如遍历读取

forfiles /C "cmd /c type @file"

![](images/20250220105021-6cdfdf36-ef35-1.png)

/M 参数指定一个搜索掩码 防止多次执行

![](images/20250220105022-6d7ca7e3-ef35-1.png)

## AppVLP

![](images/20250220105023-6e117f4b-ef35-1.png)

# 参考

<https://lolbas-project.github.io/>
