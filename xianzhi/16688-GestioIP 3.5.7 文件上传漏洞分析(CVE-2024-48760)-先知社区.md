# GestioIP 3.5.7 文件上传漏洞分析(CVE-2024-48760)-先知社区

> **来源**: https://xz.aliyun.com/news/16688  
> **文章ID**: 16688

---

# 漏洞通告

![](images/20250213103257-d5fe9fe8-e9b2-1.png)

根据漏洞通告了解漏洞文件在`upload.cgi` 并且是文件上传

# 漏洞分析

根据官网搭建环境

打开`upload.cgi`文件，环境是`perl`语法

![](images/20250213103258-d6a84712-e9b2-1.png)

漏洞点如下

![](images/20250213103259-d7174d92-e9b2-1.png)

文件上传句柄是通过`$lightweight_fh->handle`获取的

![](images/20250213103259-d771ff4c-e9b2-1.png)

`$lightweight_fh`是通过`$q->upload('leases_file');`获取文件内容的字段是`leases_file`

![](images/20250213103300-d7c01b58-e9b2-1.png)

`$filename`是要打开的文件的，如果文件不存在则创建文件

![](images/20250213103301-d82502b5-e9b2-1.png)

继续向上分析`$filename`是通过 `$q->param("file_name") || "";`获取的，如果没有这个参数那么`$filename`为空

![](images/20250213103301-d87c6803-e9b2-1.png)

因此可以确定

* file\_name参数表示文件名
* leases\_file参数表示文件内容

# 流程分析

要想到达漏洞触发点需要经过三个条件判断

```
if ( $filename !~ /^[A-Za-z0-9-_.]+$/ ){
...退出...
}

$POST_MAX=1024 * 10000;  # 10MB max
if (($POST_MAX > 0) && ($content_length > $POST_MAX)) {
...退出...
}

if (defined $lightweight_fh) {
...漏洞触发点...
}
```

根据简化代码流程可以知道要想触发漏洞，要满足三个条件

* 文件名只能是字母数字
* 文件大小不能超过10M
* 要有文件参数

# 构造payload

文件上传成功

![](images/20250213103302-d8e8c7cf-e9b2-1.png)

上传webshell

![](images/20250213103303-d9acb1bf-e9b2-1.png)

![](images/20250213103304-da59c0f6-e9b2-1.png)
