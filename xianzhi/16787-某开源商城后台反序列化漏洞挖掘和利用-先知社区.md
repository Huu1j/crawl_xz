# 某开源商城后台反序列化漏洞挖掘和利用-先知社区

> **来源**: https://xz.aliyun.com/news/16787  
> **文章ID**: 16787

---

## 漏洞分析

Manager-Api模块中cn.lili.controller.setting.RegionManagerController#synchronizationData方法用于同步高德行政地区数据，其中调用了fastjson的JSONObject.parseObject方法且参数可控。

![image.png](images/308e9002-48f9-3fa8-81f8-ca66534421b4)![](file:///C:\Users\79317\AppData\Local\Temp\ksohtml33180\wps1.jpg)

方法接收一个Stinng类型的参数url，跟进synchronizationData。

![image.png](images/e425eaf1-5fcd-39b5-ac1e-ea19cc354fed)

![](file:///C:\Users\79317\AppData\Local\Temp\ksohtml33180\wps2.jpg)

68行调用HttpClientUtils.doGet方法执行url，跟进查看。

![image.png](images/d8b0d35a-e967-3b3f-822e-540beb6f3143)

![](file:///C:\Users\79317\AppData\Local\Temp\ksohtml33180\wps3.jpg)

174行调用apache httpclient.execute执行传入的url，接着判断response是否为200，如果成立则提取响应内容并赋值给resultString后返回。

回到synchronizationData，返回的jsonString在71行传递给this.initData

方法。

![image.png](images/452b0269-2417-34b1-9d55-91933aa85a0e)

![](file:///C:\Users\79317\AppData\Local\Temp\ksohtml33180\wps4.jpg)

跟进this.initData，老生常谈的JSONObject.parseObject功能点。Fastjson组件对应的版本为1.2.78，同时项目中还存在groovy依赖，根据网上已公开的利用链可以RCE。

![image.png](images/e796739b-8b6e-3267-8326-720e73fa4199)

附上Fastjson姿势技巧集合，感兴趣的伙伴可自行探索。

<https://github.com/safe6Sec/Fastjson>

![](file:///C:\Users\79317\AppData\Local\Temp\ksohtml33180\wps5.jpg)

## **漏洞复现**

整体流程为：前台传入url—>根据url执行请求—>解析请求并获取参数—>参数传入漏洞点。

​

可以控制的地方是：前台传入的url、解析请求并获取的参数。触发漏洞需要的参数来自：解析请求并获取的参数。

​

因此，需要控制返回数据包的内容为fastjson可执行的格式，既然传入的url也是可控的，那只需要保证解析url后返回数据包内容即可。

​

思路：使用python开启http服务，将fastjson可执行的内容写入文件中，访问的url为这个文件路径即可。

​

Python开启server，文件内容如下：

{"@type":"java.net.InetSocketAddress"{"address":,"val":"zorazgd1moa7zoxhv9hfd67osfy6mv.oastify.com"}}

​

继续Debug调试：传入url，跟进doGet。

![image.png](images/1c4ad0af-dcab-310f-ab49-3291faf579b2)![](file:///C:\Users\79317\AppData\Local\Temp\ksohtml33180\wps6.jpg)

跟进httpClient.execute方法。

![image.png](images/17e6e764-3c72-337c-b3e4-88bd5571996f)

![image.png](images/163dcc27-f70e-3a7a-a19f-7ac954c0e45f)![](file:///C:\Users\79317\AppData\Local\Temp\ksohtml33180\wps8.jpg)

返回response.getEntity内容。

![image.png](images/7077b974-db73-3c49-8b0b-9e8e7e85d6bb)

![image.png](images/089ae73c-3371-3006-a95f-405fa1ec273e)

![image.png](images/35bda06d-1c1e-3e0e-ae2f-1a7eaf0929a1)

![](file:///C:\Users\79317\AppData\Local\Temp\ksohtml33180\wps12.jpg)Dnslog成功收到请求。

![image.png](images/613d56c9-c4a4-39e9-8cc2-a390001c5e05)

​

## **漏洞利用**

利用链：Fastjson1.2.78+groovy

​

Goovy利用链的模版：https://github.com/Lonely-night/fastjsonVul，

​

发现第一次反序列化将org.codehaus.groovy.control.ProcessingUnit 加入白名单，第二次反序列化加载自定义的恶意类。

![image.png](images/3019c846-5d9e-3ccf-a3a0-8f00d6582553)

​

只需要把加载恶意类的方法写入GrabAnnotationTransformation2中即可。![image.png](images/8db2529d-0223-30f8-85d8-c1dc7f8b71c9)

​

修改后如下，加载自定义Filter。

![image.png](images/3255349e-4261-3080-8b66-bbaf9c8ff7c0)

​

测试cmd回显成功。

![image.png](images/829f0ef0-0afd-3c07-b569-10cad4bf0ef0)

测试冰蝎连接成功。

![image.png](images/c1bba528-0840-30c1-9fa7-3338849909d3)
