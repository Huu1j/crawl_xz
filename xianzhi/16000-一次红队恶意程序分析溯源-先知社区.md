# 一次红队恶意程序分析溯源-先知社区

> **来源**: https://xz.aliyun.com/news/16000  
> **文章ID**: 16000

---

此恶意程序图标伪装成二维码，让受害者以为这是图片，从而双击打开

![](images/20241205153514-77b095ae-b2db-1.png)  
程序修改了注册表， 用于隐藏和持久化，`RegOpenKeyW` 多次被调用，目标注册表键包括 `HKEY_USERS`、`HKEY_CURRENT_USER` 和 `HKEY_LOCAL_MACHINE`

![](images/20241205153542-87ffebb2-b2db-1.png)  
通过动态调试，修改的注册表为

```
HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon\Userinit
HKEY_CURRENT_USER\SOFTWARE\Microsoft\Windows\CurrentVersion\Run
```

注册表项Userinit是 Windows 系统登录流程的关键部分，用于指定登录后执行的程序 ，另一个注册表也就是添加到启动项

![](images/20241205153613-9a824fc8-b2db-1.png)  
调整自身优先级，动态调试环境下线程优先级可能会被修改，线程优先级过高可能会触发退出逻辑，干扰调试

![](images/20241205153624-a158cfca-b2db-1.png)  
白+黑，加载了动态库

![](images/20241205153633-a6b761e8-b2db-1.png)  
加载了非系统路径中的 twain\_32.dll，DLL 劫持攻击

![](images/20241205153649-b02b49d8-b2db-1.png)  
反调试，无限循环

![](images/20241205153659-b62a1526-b2db-1.png)

代码大量操作通过位操作、移位、减法等方式，为了避免静态分析直接理解数据逻辑

![](images/20241205153729-c8245c5a-b2db-1.png)

网络流量：

![](images/20241205153755-d76707b2-b2db-1.png)  
在线网站分析不出来时可以使用wireshark查看网络流量

![](images/20241205153800-da5bebc2-b2db-1.png)

```
文件hash：ef8e448d10ad0bd7e148f0115a192aa8
远控网站：http://ww12.gatyhub.com
ip：13.248.148.254
```
