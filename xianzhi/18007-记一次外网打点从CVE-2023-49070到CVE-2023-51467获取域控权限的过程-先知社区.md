# 记一次外网打点从CVE-2023-49070到CVE-2023-51467获取域控权限的过程-先知社区

> **来源**: https://xz.aliyun.com/news/18007  
> **文章ID**: 18007

---

返回文档

信息收集  
   
端口扫描  
   
使用nmap进行端口探测，发现存在22，80，443，41525等端口开放。  
   

![image.png](images/20250515165237-f339c81e-3169-1.png)

  
然后探测具体协议。  
   

![image.png](images/20250515165238-f43d23dd-3169-1.png)

  
Web页面  
   
访问web页面。  
   

![image.png](images/20250515165244-f79f2382-3169-1.png)

  
发现存在web-INF接口。

![image.png](images/20250515165248-f9fabbba-3169-1.png)

  
目录爆破  
   
使用工具爆破目录。  
   

![image.png](images/20250515165250-fb4d8d05-3169-1.png)

  
CVE漏洞搜索  
   
发现存在cve-2023-49070漏洞，漏洞原因是：Apache Ofbiz 18.12.09 中的预认证 RCE。这是由于 XML-RPC 不再维护而仍然存在。此问题影响 Apache OFBiz：18.12.10 之前的版本。建议用户升级到版本 18.12.10。  
   
使用poc进行测试。  
   

![image.png](images/20250515165254-fdbdcbd5-3169-1.png)

  
漏洞利用  
   
访问页面。  
   

![image.png](images/20250515165257-ff447929-3169-1.png)

  
进行漏洞利用。

![image.png](images/20250515165258-fff00762-3169-1.png)

  
配置环境为jdk11.  
   

![image.png](images/20250515165300-012c2162-316a-1.png)

  
命令执行漏洞  
   
然后使用工具进行执行命令尝试。  
   

![image.png](images/20250515165302-025e98fb-316a-1.png)

  
反弹shell  
   
接着进行反弹shell  
   

![image.png](images/20250515165303-02ee00df-316a-1.png)

  
升级shell权限。

![image.png](images/20250515165304-03b6f3b1-316a-1.png)

  
内网信息收集  
   
接着进行内网收集，发现一个压缩包。

![image.png](images/20250515165306-0491d982-316a-1.png)

  
解压之后，查看压缩包内容。  
   

![image.png](images/20250515165307-059bc7cd-316a-1.png)

  
查看日志文件  
   
查看日志文件，发现存在derby.log文件。  
   

![image.png](images/20250515165309-06ae6f4f-316a-1.png)

  
查看日志文件，发现存在数据库信息。  
   

![image.png](images/20250515165310-076def28-316a-1.png)

  
运行IJ工具，进行枚举数据库。  
   

![image.png](images/20250515165312-085e8d49-316a-1.png)

  
获取数据库用户hash  
   
通过翻找数据库文件，发现存在用户密码的HASH。  
   

![image.png](images/20250515165314-0978dab1-316a-1.png)

  
![image.png](images/20250515165315-0a5880a3-316a-1.png)

  
接着进行破解用户hash。  
   

![image.png](images/20250515165317-0b2aa9f5-316a-1.png)

![image.png](images/20250515165318-0c2c49f8-316a-1.png)

  
hash爆破  
   
尝试进行hash爆破。  
   

![image.png](images/20250515165320-0d67c6d5-316a-1.png)

  
权限提升  
   
接着使用su -进行权限提升，切换到root用户。  
   
获取root.txt  
   

![image.png](images/20250515165322-0e874382-316a-1.png)

  
总结  
   
CVE-2023-51467  
   
影响版本  
   
Apache ofbiz applications < =18.12.10 due to xml-rpc java deserialzation bug.
多了个版本，在18.12.10中，官方移除了xmrpc组件，但是鉴权问题仍然存在，咱就是说不能一起修了。  
   
漏洞复现  
   
这一个是用groovy表达式rce，配合鉴权绕过，那么就可以访问任意接口，因此rce的可能性还是那么大。  
   
漏洞分析  
   
鉴权部分就一样了。groovy执行部分如下  
   

![](images/1710040379934-63b1f9df-ec43-4a47-bed3-b21a952a66d5.png)

![](data:image/svg+xml;utf8,%3C%3Fxml%20version%3D%221.0%22%20encoding%3D%22UTF-8%22%3F%3E%0A%3Csvg%20width%3D%2218px%22%20height%3D%2216px%22%20viewBox%3D%220%200%2018%2016%22%20version%3D%221.1%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20xmlns%3Axlink%3D%22http%3A%2F%2Fwww.w3.org%2F1999%2Fxlink%22%3E%0A%20%20%20%20%3Cg%20id%3D%22%E9%A1%B5%E9%9D%A2-2%22%20stroke%3D%22none%22%20stroke-width%3D%221%22%20fill%3D%22none%22%20fill-rule%3D%22evenodd%22%3E%0A%20%20%20%20%20%20%20%20%3Cg%20id%3D%22%E5%85%B6%E4%BB%96%E5%8D%A1%E7%89%87%22%20transform%3D%22translate(-831.000000%2C%20-7078.000000)%22%3E%0A%20%20%20%20%20%20%20%20%20%20%20%20%3Cg%20id%3D%22%E7%BC%96%E7%BB%84-10%22%20transform%3D%22translate(729.000000%2C%207032.000000)%22%3E%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Cg%20id%3D%22%E7%BC%96%E7%BB%84-15%22%20transform%3D%22translate(102.000000%2C%2046.000000)%22%3E%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Cg%20id%3D%22image%E5%A4%87%E4%BB%BD%22%3E%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Crect%20id%3D%22%E7%9F%A9%E5%BD%A2%22%20fill%3D%22%23000000%22%20fill-rule%3D%22nonzero%22%20opacity%3D%220%22%20x%3D%220%22%20y%3D%220%22%20width%3D%2216%22%20height%3D%2216%22%3E%3C%2Frect%3E%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Cpath%20d%3D%22M2.125%2C12.375%20L2.125%2C10.4960156%20L4.194125%2C8.042375%20C4.24407812%2C7.98315625%204.33529688%2C7.98315625%204.38525%2C8.042375%20L6.63471875%2C10.7098437%20L10.1869531%2C6.49754687%20C10.2369063%2C6.43832812%2010.328125%2C6.43832812%2010.3780781%2C6.49754687%20L13.875%2C10.64425%20L13.875%2C12.375%20L13.875%2C3.625%20L2.125%2C3.625%20L2.125%2C12.375%20Z%20M1.5%2C2.5%20L14.5%2C2.5%20C14.7761406%2C2.5%2015%2C2.72385937%2015%2C3%20L15%2C13%20C15%2C13.2761406%2014.7761406%2C13.5%2014.5%2C13.5%20L1.5%2C13.5%20C1.22385937%2C13.5%201%2C13.2761406%201%2C13%20L1%2C3%20C1%2C2.72385937%201.22385937%2C2.5%201.5%2C2.5%20Z%20M4.75%2C7%20C4.05964063%2C7%203.5%2C6.44035937%203.5%2C5.75%20C3.5%2C5.05964063%204.05964063%2C4.5%204.75%2C4.5%20C5.44035937%2C4.5%206%2C5.05964063%206%2C5.75%20C6%2C6.44035937%205.44035937%2C7%204.75%2C7%20Z%22%20id%3D%22%E5%BD%A2%E7%8A%B6%22%20fill%3D%22%238C8C8C%22%3E%3C%2Fpath%3E%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3C%2Fg%3E%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Cg%20id%3D%22alert-fill%22%20transform%3D%22translate(9.000000%2C%207.000000)%22%3E%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Cpath%20d%3D%22M4.870227%2C0.216197695%20L8.94272401%2C7.35134981%20C9.01909103%2C7.48514349%209.01909206%2C7.64998385%208.94272672%2C7.78377851%20C8.86636138%2C7.91757317%208.72523106%2C8%208.57249701%2C8%20L0.427502991%2C8%20C0.274768942%2C8%200.133638625%2C7.91757317%200.0572732809%2C7.78377851%20C-0.0190920629%2C7.64998385%20-0.0190910287%2C7.48514349%200.0572759941%2C7.35134981%20L4.129773%2C0.216197695%20C4.20614384%2C0.0824130438%204.34727177%2C0%204.5%2C0%20C4.65272823%2C0%204.79385616%2C0.0824130438%204.870227%2C0.216197695%20Z%22%20id%3D%22%E5%BD%A2%E7%8A%B6%22%20fill%3D%22%23F7D844%22%3E%3C%2Fpath%3E%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Cpolygon%20id%3D%22%E8%B7%AF%E5%BE%84%22%20fill%3D%22%23FFFFFF%22%20points%3D%224.07248614%205.8378327%204.07248614%206.70269962%204.92751386%206.70269962%204.92751386%205.8378327%22%3E%3C%2Fpolygon%3E%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Cpolygon%20id%3D%22%E8%B7%AF%E5%BE%84%22%20fill%3D%22%23FFFFFF%22%20points%3D%224.07248614%202.81079846%204.07248614%204.97296577%204.92751386%204.97296577%204.92751386%202.81079846%204.07248614%202.81079846%22%3E%3C%2Fpolygon%3E%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3C%2Fg%3E%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3C%2Fg%3E%0A%20%20%20%20%20%20%20%20%20%20%20%20%3C%2Fg%3E%0A%20%20%20%20%20%20%20%20%3C%2Fg%3E%0A%20%20%20%20%3C%2Fg%3E%0A%3C%2Fsvg%3E%0A)

图片加载失败

获取groovyparam然后执行。

![](images/1710040392531-c700620f-6947-4670-afe2-39d60400a34e.png)

![](data:image/svg+xml;utf8,%3C%3Fxml%20version%3D%221.0%22%20encoding%3D%22UTF-8%22%3F%3E%0A%3Csvg%20width%3D%2218px%22%20height%3D%2216px%22%20viewBox%3D%220%200%2018%2016%22%20version%3D%221.1%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20xmlns%3Axlink%3D%22http%3A%2F%2Fwww.w3.org%2F1999%2Fxlink%22%3E%0A%20%20%20%20%3Cg%20id%3D%22%E9%A1%B5%E9%9D%A2-2%22%20stroke%3D%22none%22%20stroke-width%3D%221%22%20fill%3D%22none%22%20fill-rule%3D%22evenodd%22%3E%0A%20%20%20%20%20%20%20%20%3Cg%20id%3D%22%E5%85%B6%E4%BB%96%E5%8D%A1%E7%89%87%22%20transform%3D%22translate(-831.000000%2C%20-7078.000000)%22%3E%0A%20%20%20%20%20%20%20%20%20%20%20%20%3Cg%20id%3D%22%E7%BC%96%E7%BB%84-10%22%20transform%3D%22translate(729.000000%2C%207032.000000)%22%3E%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Cg%20id%3D%22%E7%BC%96%E7%BB%84-15%22%20transform%3D%22translate(102.000000%2C%2046.000000)%22%3E%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Cg%20id%3D%22image%E5%A4%87%E4%BB%BD%22%3E%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Crect%20id%3D%22%E7%9F%A9%E5%BD%A2%22%20fill%3D%22%23000000%22%20fill-rule%3D%22nonzero%22%20opacity%3D%220%22%20x%3D%220%22%20y%3D%220%22%20width%3D%2216%22%20height%3D%2216%22%3E%3C%2Frect%3E%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Cpath%20d%3D%22M2.125%2C12.375%20L2.125%2C10.4960156%20L4.194125%2C8.042375%20C4.24407812%2C7.98315625%204.33529688%2C7.98315625%204.38525%2C8.042375%20L6.63471875%2C10.7098437%20L10.1869531%2C6.49754687%20C10.2369063%2C6.43832812%2010.328125%2C6.43832812%2010.3780781%2C6.49754687%20L13.875%2C10.64425%20L13.875%2C12.375%20L13.875%2C3.625%20L2.125%2C3.625%20L2.125%2C12.375%20Z%20M1.5%2C2.5%20L14.5%2C2.5%20C14.7761406%2C2.5%2015%2C2.72385937%2015%2C3%20L15%2C13%20C15%2C13.2761406%2014.7761406%2C13.5%2014.5%2C13.5%20L1.5%2C13.5%20C1.22385937%2C13.5%201%2C13.2761406%201%2C13%20L1%2C3%20C1%2C2.72385937%201.22385937%2C2.5%201.5%2C2.5%20Z%20M4.75%2C7%20C4.05964063%2C7%203.5%2C6.44035937%203.5%2C5.75%20C3.5%2C5.05964063%204.05964063%2C4.5%204.75%2C4.5%20C5.44035937%2C4.5%206%2C5.05964063%206%2C5.75%20C6%2C6.44035937%205.44035937%2C7%204.75%2C7%20Z%22%20id%3D%22%E5%BD%A2%E7%8A%B6%22%20fill%3D%22%238C8C8C%22%3E%3C%2Fpath%3E%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3C%2Fg%3E%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Cg%20id%3D%22alert-fill%22%20transform%3D%22translate(9.000000%2C%207.000000)%22%3E%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Cpath%20d%3D%22M4.870227%2C0.216197695%20L8.94272401%2C7.35134981%20C9.01909103%2C7.48514349%209.01909206%2C7.64998385%208.94272672%2C7.78377851%20C8.86636138%2C7.91757317%208.72523106%2C8%208.57249701%2C8%20L0.427502991%2C8%20C0.274768942%2C8%200.133638625%2C7.91757317%200.0572732809%2C7.78377851%20C-0.0190920629%2C7.64998385%20-0.0190910287%2C7.48514349%200.0572759941%2C7.35134981%20L4.129773%2C0.216197695%20C4.20614384%2C0.0824130438%204.34727177%2C0%204.5%2C0%20C4.65272823%2C0%204.79385616%2C0.0824130438%204.870227%2C0.216197695%20Z%22%20id%3D%22%E5%BD%A2%E7%8A%B6%22%20fill%3D%22%23F7D844%22%3E%3C%2Fpath%3E%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Cpolygon%20id%3D%22%E8%B7%AF%E5%BE%84%22%20fill%3D%22%23FFFFFF%22%20points%3D%224.07248614%205.8378327%204.07248614%206.70269962%204.92751386%206.70269962%204.92751386%205.8378327%22%3E%3C%2Fpolygon%3E%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Cpolygon%20id%3D%22%E8%B7%AF%E5%BE%84%22%20fill%3D%22%23FFFFFF%22%20points%3D%224.07248614%202.81079846%204.07248614%204.97296577%204.92751386%204.97296577%204.92751386%202.81079846%204.07248614%202.81079846%22%3E%3C%2Fpolygon%3E%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3C%2Fg%3E%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3C%2Fg%3E%0A%20%20%20%20%20%20%20%20%20%20%20%20%3C%2Fg%3E%0A%20%20%20%20%20%20%20%20%3C%2Fg%3E%0A%20%20%20%20%3C%2Fg%3E%0A%3C%2Fsvg%3E%0A)

图片加载失败

​
