name: è‡ªåŠ¨çˆ¬å–å®‰å…¨ç¤¾åŒºæ–‡ç« 

on:
  # å®šæ—¶ä»»åŠ¡ï¼šæ¯å¤©UTC 0:00 (åŒ—äº¬æ—¶é—´8:00) è¿è¡Œ
  schedule:
    - cron: '0 0 * * *'
  
  # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      site:
        description: 'é€‰æ‹©çˆ¬å–çš„ç«™ç‚¹'
        required: true
        default: 'both'
        type: choice
        options:
          - xianzhi
          - butian
          - both
      start_id:
        description: 'èµ·å§‹æ–‡ç« IDï¼ˆå¯é€‰ï¼Œç•™ç©ºåˆ™è‡ªåŠ¨é€’å¢ï¼‰'
        required: false
        type: string
      end_id:
        description: 'ç»“æŸæ–‡ç« IDï¼ˆå¯é€‰ï¼Œç•™ç©ºåˆ™è‡ªåŠ¨é€’å¢ï¼‰'
        required: false
        type: string
      format:
        description: 'è¾“å‡ºæ ¼å¼'
        required: true
        default: 'md'
        type: choice
        options:
          - md
          - md+pdf
          - all

jobs:
  crawl:
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²è®°å½•
      
      - name: è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          cache: 'pip'
      
      - name: å®‰è£…ç³»ç»Ÿä¾èµ–
        run: |
          sudo apt-get update
          sudo apt-get install -y wget unzip xvfb libxi6 libgconf-2-4
          
          # å®‰è£…Chrome
          wget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
          sudo sh -c 'echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" >> /etc/apt/sources.list.d/google-chrome.list'
          sudo apt-get update
          sudo apt-get install -y google-chrome-stable
          
          # å®‰è£…wkhtmltopdfï¼ˆç”¨äºPDFç”Ÿæˆï¼‰
          sudo apt-get install -y wkhtmltopdf
      
      - name: å®‰è£…Pythonä¾èµ–
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: è¯»å–ä¸Šæ¬¡çˆ¬å–çš„ID
        id: read_ids
        run: |
          # åˆ›å»ºIDè®°å½•æ–‡ä»¶ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
          mkdir -p .github/crawl_state
          
          # å…ˆçŸ¥ç¤¾åŒº
          if [ ! -f .github/crawl_state/xianzhi_last_id.txt ]; then
            echo "18000" > .github/crawl_state/xianzhi_last_id.txt
          fi
          XZ_LAST_ID=$(cat .github/crawl_state/xianzhi_last_id.txt)
          echo "xz_last_id=$XZ_LAST_ID" >> $GITHUB_OUTPUT
          
          # å¥‡å®‰ä¿¡æ”»é˜²ç¤¾åŒº
          if [ ! -f .github/crawl_state/butian_last_id.txt ]; then
            echo "2400" > .github/crawl_state/butian_last_id.txt
          fi
          BT_LAST_ID=$(cat .github/crawl_state/butian_last_id.txt)
          echo "bt_last_id=$BT_LAST_ID" >> $GITHUB_OUTPUT
      
      - name: çˆ¬å–å…ˆçŸ¥ç¤¾åŒºæ–‡ç« 
        if: ${{ github.event.inputs.site != 'butian' || github.event_name == 'schedule' }}
        run: |
          # ç¡®å®šIDèŒƒå›´
          if [ -n "${{ github.event.inputs.start_id }}" ]; then
            START_ID=${{ github.event.inputs.start_id }}
          else
            START_ID=${{ steps.read_ids.outputs.xz_last_id }}
          fi
          
          if [ -n "${{ github.event.inputs.end_id }}" ]; then
            END_ID=${{ github.event.inputs.end_id }}
          else
            END_ID=$((START_ID + 10))  # æ¯æ¬¡çˆ¬å–10ç¯‡
          fi
          
          FORMAT="${{ github.event.inputs.format }}"
          if [ -z "$FORMAT" ]; then
            FORMAT="md"  # é»˜è®¤åªç”ŸæˆMarkdownï¼ŒèŠ‚çœç©ºé—´
          fi
          
          echo "çˆ¬å–å…ˆçŸ¥ç¤¾åŒºæ–‡ç«  $START_ID åˆ° $END_ID"
          python crawl_xz_aliyun.py --start $START_ID --end $END_ID --format $FORMAT --sleep 3
          
          # æ›´æ–°æœ€åçˆ¬å–çš„ID
          echo $END_ID > .github/crawl_state/xianzhi_last_id.txt
        continue-on-error: true
      
      - name: çˆ¬å–å¥‡å®‰ä¿¡æ”»é˜²ç¤¾åŒºæ–‡ç« 
        if: ${{ github.event.inputs.site != 'xianzhi' || github.event_name == 'schedule' }}
        run: |
          # ç¡®å®šIDèŒƒå›´
          if [ -n "${{ github.event.inputs.start_id }}" ]; then
            START_ID=${{ github.event.inputs.start_id }}
          else
            START_ID=${{ steps.read_ids.outputs.bt_last_id }}
          fi
          
          if [ -n "${{ github.event.inputs.end_id }}" ]; then
            END_ID=${{ github.event.inputs.end_id }}
          else
            END_ID=$((START_ID + 10))  # æ¯æ¬¡çˆ¬å–10ç¯‡
          fi
          
          FORMAT="${{ github.event.inputs.format }}"
          if [ -z "$FORMAT" ]; then
            FORMAT="md"
          fi
          
          echo "çˆ¬å–å¥‡å®‰ä¿¡æ”»é˜²ç¤¾åŒºæ–‡ç«  $START_ID åˆ° $END_ID"
          python crawl_butian_forum.py --start $START_ID --end $END_ID --format $FORMAT --sleep 5
          
          # æ›´æ–°æœ€åçˆ¬å–çš„ID
          echo $END_ID > .github/crawl_state/butian_last_id.txt
        continue-on-error: true
      
      - name: ç”Ÿæˆæ–‡ç« ç´¢å¼•
        run: |
          python .github/scripts/generate_index.py
        continue-on-error: true
      
      - name: æäº¤æ›´æ”¹
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          git add .
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
          if git diff --staged --quiet; then
            echo "æ²¡æœ‰æ–°æ–‡ç« "
          else
            TIMESTAMP=$(date +'%Y-%m-%d %H:%M:%S')
            git commit -m "ğŸ¤– è‡ªåŠ¨çˆ¬å–æ–‡ç«  - $TIMESTAMP"
            git push
          fi
      
      - name: ä¸Šä¼ çˆ¬å–æ—¥å¿—
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: crawl-logs
          path: |
            xianzhi/*.md
            butian/*.md
          retention-days: 7

